{% load i18n pcart_core %}
{% if products.paginator.num_pages > 1 %}
<div class="product_listing_controls">
<p class="products_count">{{products.number}} / {{products.paginator.num_pages}}</p>
{% endif %}
{% if products.has_other_pages %}
  {% with p_url=request.get_full_path %}
  <div id="pagination">
    {% if products.has_previous %}
      <span class="prev"><a href="{% set_query_parameter p_url 'page' products.previous_page_number %}">&laquo;</a></span>
    {% else %}
      <span class="prev"><a>&laquo;</a></span>
    {% endif %}
    {% for i in products.paginator.page_range %}
        {# if we're beyond the first five pages, just show "..." until three pages before the current page #}
        {# e.g. on page 12 show: "... 9 10 11 12" #}
        {% if products.number > 5 and i < products.number|subtract:4 %}
                {% if i|subtract:3 <= 0 %}<span class="page"><a href="{% set_query_parameter p_url 'page' i %}">{{ i }}</a></span>{% endif %}
        {% elif products.number > 5 and i == products.number|subtract:4 %}
                {# show '...' #}
                <span class="page"><a>...</a></span>
        {# if we're before the last five pages, just show "..." for pages more than three after the current page #}
        {# e.g. on page 1 of 10 show: "1 2 3 4 ..." #}
        {% elif products.number < products.paginator.num_pages|subtract:5 and i > products.number|add:4 %}
            {% if i|add:3 > products.paginator.num_pages %}<span><a href="{% set_query_parameter p_url 'page' i %}">{{ i }}</a></span>{% endif %}
        {% elif products.number < products.paginator.num_pages|subtract:5 and i == products.number|add:4 %}
            {# show '...' #}
                <span class="page"><a>...</a></span>
        {% elif products.number == i %}
            <span class="page current">{{ i }}</span>
        {% else %}
            <span class="page"><a href="{% set_query_parameter p_url 'page' i %}">{{ i }}</a></span>
        {% endif %}

    {% endfor %}
    {% if products.has_next %}
      <span class="next"><a href="{% set_query_parameter p_url 'page' products.next_page_number %}">&raquo;</a></span>
    {% else %}
      <span class="next"><a>&raquo;</a></span>
    {% endif %}
  </div>
  {% endwith %}
</div>
{% endif %}