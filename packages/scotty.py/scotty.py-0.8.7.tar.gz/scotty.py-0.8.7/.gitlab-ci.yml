stages:
  - test
  - deploy
  - release
  - cleanup

test:
  stage: test
  image: python:2
  script:
    - pip install -e .
    - pip install -r test-requirements.txt
    - pytest

release_pypi:
  stage: release
  image: python:2
  script:
    - echo "[server-login]" >> ~/.pypirc
    - echo "username=" ${PYPI_USER} >> ~/.pypirc
    - echo "password=" ${PYPI_PASSWORD} >> ~/.pypirc
    - python setup.py check sdist upload 
    - echo "" > ~/.pypirc && rm ~/.pypirc 
  only:
    - /^v\d+\.\d+\.\d+([abc]\d*)?$/ 
    - tags

cleanup_pypirc:
   stage: cleanup
   image: python:2
   when: always   
   script:
    - rm -vf ~/.pypirc
